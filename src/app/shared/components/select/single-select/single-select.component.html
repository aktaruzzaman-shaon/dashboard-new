@if (isOpen()) {
  <div class="fixed inset-0 z-40 bg-black/20" (click)="isOpen.set(false)"></div>
}

<div class="w-full">
  <div class="relative text-gray-800" [class.z-50]="isOpen()">
    <label class="block text-sm font-medium text-gray-700 mb-2">{{ label() }}</label>
    <button
      (click)="toggle()"
      class="flex w-full items-center justify-between rounded-lg border border-gray-300 bg-white px-4 py-2.5 shadow-sm transition-all hover:border-gray-400 focus:outline-none"
    >
      <span class="text-sm font-medium">{{ displayLabel() }}</span>
      <svg
        class="h-4 w-4 text-gray-500 transition-transform duration-200"
        [class.rotate-180]="isOpen()"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    @if (isOpen()) {
      <div
        class="fixed z-50 mt-2 rounded-xl border border-gray-100 bg-white py-2 shadow-2xl min-w-[20rem] sm:min-w-[25rem] max-w-[90vw] w-auto"
        style="left: var(--dropdown-left); top: var(--dropdown-top)"
      >
        <div
          class="mx-3 mt-1 flex items-center rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 focus-within:border-blue-400 focus-within:ring-1 focus-within:ring-blue-400"
        >
          <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
          <input
            type="text"
            placeholder="Search city..."
            class="ml-2 w-full bg-transparent text-sm outline-none placeholder:text-gray-400"
            [value]="searchTerm()"
            (input)="searchTerm.set($any($event.target).value)"
            (click)="$event.stopPropagation()"
          />
        </div>

        <!-- <div class="flex items-center px-4 py-2">
        <img src="https://flagcdn.com/ae.svg" alt="UAE" class="h-3.5 w-5 rounded-sm object-cover shadow-sm">
        <span class="ml-3 flex-grow text-sm font-bold text-gray-700">United Arab Emirates</span>
        <svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
      </div> -->

        <ul class="max-h-60 overflow-y-auto px-2">
          @for (country of filteredItems(); track country.country) {
            <!-- Country Header -->
            <li
              class="flex items-center justify-between px-3 py-2 mb-2.5 cursor-pointer rounded-lg hover:bg-gray-50"
              (click)="toggleCountry(country.country)"
            >
              <div class="flex items-center gap-3">
                <img
                  [src]="'https://flagcdn.com/w20/' + country.code + '.png'"
                  class="h-4 w-6 rounded-sm shadow-sm"
                  alt="flag"
                />
                <span class="text-sm font-semibold text-gray-700">
                  {{ country.country }}
                </span>
              </div>

              <svg
                class="h-4 w-4 transition-transform"
                [class.rotate-180]="openCountries().has(country.country)"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </li>

            <!-- Cities -->
            @if (openCountries().has(country.country)) {
              <ul class="ml-6 pl-4">
                @for (city of country.cities; track city.value) {
                  <li
                    (click)="select(city)"
                    class="group flex cursor-pointer border-b border-gray-200 items-center justify-between py-2 pr-4 hover:bg-blue-50 rounded-md"
                  >
                    <span class="text-sm text-gray-600 group-hover:text-blue-700">
                      {{ city.label }}
                    </span>

                    <div
                      class="flex h-4.5 w-4.5 items-center justify-center rounded-full border-2"
                      [class.border-blue-500]="selectedItem()?.value === city.value"
                      [class.border-gray-200]="selectedItem()?.value !== city.value"
                    >
                      @if (selectedItem()?.value === city.value) {
                        <div class="h-2.5 w-2.5 rounded-full bg-blue-500"></div>
                      }
                    </div>
                  </li>
                }
              </ul>
            }
          } @empty {
            <li class="px-4 py-8 text-center text-sm text-gray-400">
              No results found for "{{ searchTerm() }}"
            </li>
          }
        </ul>
      </div>
    }
  </div>
</div>
